<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Результаты поиска - Work Eye</title>
  
  
  <style type="text/css">@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Orbitron;font-style:normal;font-weight:700;src:url(/cf-fonts/v/orbitron/5.0.18/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}</style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="stars" class="stars"></div>
  <div class="nebula"></div>
  <div class="content">
    <header>
      <a href="index.html" class="back-link" data-lang="back">← Назад</a>
      <h1 data-lang="search-results">Результаты поиска</h1>
      <a href="profile.html" class="profile-icon">P</a>
    </header>
    <hr>

    <div class="search-results">
      <div class="query-info">
        <h2 id="query-display"></h2>
      </div>
      <div id="results-grid" class="results-grid">
          </div>
      <div id="no-results" class="no-results" style="display: none;" data-lang="no-results">Ничего не найдено по вашему запросу.</div>
    </div>
  </div>

  <script>
    let currentUserId = null; // ID текущего пользователя

    const trans = {
      ru: {
        "back": "← Назад",
        "search-results": "Результаты поиска",
        "no-results": "Ничего не найдено по вашему запросу."
      },
      en: {
        "back": "← Back",
        "search-results": "Search Results",
        "no-results": "Nothing found for your query."
      }
    };

    function applyLang(lang) {
      localStorage.setItem('lang', lang);
      document.querySelectorAll('[data-lang]').forEach(el => {
        const key = el.getAttribute('data-lang');
        if (trans[lang]?.[key]) el.textContent = trans[lang][key];
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Имитация получения ID пользователя
      const tg = window.Telegram?.WebApp;
      if (tg && tg.initDataUnsafe.user) {
        currentUserId = tg.initDataUnsafe.user.id;
      } else {
        if (!localStorage.getItem('dev_user_id')) {
          localStorage.setItem('dev_user_id', Date.now());
        }
        currentUserId = parseInt(localStorage.getItem('dev_user_id'));
      }

      applyLang(localStorage.getItem('lang') || 'ru');
      performSearch();
    });

    // --- ФОН ---
    function createStars() {
      const starsContainer = document.getElementById('stars');
      if (!starsContainer) return;
      const starCount = 200;

      for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = Math.random() * 2 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (Math.random() * 2 + 1) + 's';
        starsContainer.appendChild(star);
      }
    }

    let mouseTimeout;
    let currentTransform = 'translate(0px, 0px)';

    document.addEventListener('mousemove', (e) => {
      const starsContainer = document.getElementById('stars');
      if (!starsContainer) return;
      const speed = 0.02;
      const x = (e.clientX - window.innerWidth / 2) * speed;
      const y = (e.clientY - window.innerHeight / 2) * speed;
      currentTransform = `translate(${x}px, ${y}px)`;

      clearTimeout(mouseTimeout);

      starsContainer.style.transform = currentTransform;

      mouseTimeout = setTimeout(() => {
        starsContainer.style.transform = 'translate(0px, 0px)';
        currentTransform = 'translate(0px, 0px)';
      }, 1000);
    });

    document.addEventListener('mousemove', (e) => {
      const nebula = document.querySelector('.nebula');
      if (!nebula) return;
      const speed = 0.005;
      const nx = (e.clientX - window.innerWidth / 2) * speed;
      const ny = (e.clientY - window.innerHeight / 2) * speed;
      nebula.style.transform = `translate(${nx}px, ${ny}px)`;
    });

    createStars();

    const urlParams = new URLSearchParams(window.location.search);
    const query = decodeURIComponent(urlParams.get('query') || '');
    const mode = urlParams.get('mode') || 'work';

    const lang = localStorage.getItem('lang') || 'ru';
    let queryText = `Результаты по запросу: "${query}"`;
    if (lang === 'en') {
      queryText = `Results for query: "${query}"`;
    }
    document.getElementById('query-display').textContent = queryText;
    
    function getCurrentUser() {
      const users = JSON.parse(localStorage.getItem('users')) || [];
      return users.find(u => u.id == currentUserId);
    }
    
    function createCardHTML(cardData) {
      const cardClass = cardData.type === 'service' ? 'e-card' : 'work-card';
      let buttonText = cardData.type === 'service' ? 'Заказать услугу' : 'Взять в работу';
      if (lang === 'en') {
        buttonText = cardData.type === 'service' ? 'Order Service' : 'Take Job';
      }

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const creator = users.find(u => u.id == cardData.creatorId);
      const isVip = creator?.vip;

      let vipClass = '';
      if (isVip) {
        vipClass = 'vip-card';
      }

      return `
        <div class="${cardClass} ${vipClass} playing" data-title="${cardData.title}">
          <div class="wave"></div><div class="wave"></div><div class="wave"></div>
          <div class="image"></div>
          <div class="infotop">
            ${cardData.title}<br>
            <div class="name">от ${cardData.creatorNick}</div>
          </div>
          <button class="card-action-button" onclick="startChat('${cardData.creatorId}')">${buttonText}</button>
        </div>
      `;
    }

    function performSearch() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const resultsGrid = document.getElementById('results-grid');
      const noResults = document.getElementById('no-results');
      let foundCards = [];
      const lowerCaseQuery = query.toLowerCase().trim();
      const queryWords = lowerCaseQuery ? lowerCaseQuery.split(/\s+/).filter(w => w.length > 0) : [];

      users.forEach(user => {
        // Не показываем собственные карточки
        if (user.id === currentUserId) return;

        let cardsToSearch = [];
        if (mode === 'performer') { // Ищем услуги
          cardsToSearch = user.pricelist || [];
        } else { // Ищем работу
          cardsToSearch = user.works || [];
        }

        cardsToSearch.forEach(card => {
          const lowerTitle = card.title.toLowerCase();
          const matches = queryWords.length === 0 || queryWords.every(word => lowerTitle.includes(word));
          if (matches) {
            const cardType = mode === 'performer' ? 'service' : 'work';
            foundCards.push({
              type: cardType,
              title: card.title,
              creatorId: user.id,
              creatorNick: user.nick || 'User'
            });
          }
        });
      });

      if (foundCards.length === 0) {
        noResults.style.display = 'block';
        resultsGrid.innerHTML = '';
        return;
      }
      
      noResults.style.display = 'none';
      resultsGrid.innerHTML = foundCards.map(createCardHTML).join('');
    }

    function startChat(otherUserId) {
      if (otherUserId === currentUserId) {
        let alertMsg = "Вы не можете начать чат с самим собой.";
        if (lang === 'en') alertMsg = "You cannot start a chat with yourself.";
        alert(alertMsg);
        return;
      }

      const chats = JSON.parse(localStorage.getItem('chats')) || [];
      // Проверяем, существует ли уже чат между этими пользователями
      let existingChat = chats.find(chat => 
        chat.participants.includes(currentUserId) && chat.participants.includes(otherUserId)
      );

      if (existingChat) {
        let alertMsg = "Чат с этим пользователем уже существует!";
        if (lang === 'en') alertMsg = "Chat with this user already exists!";
        alert(alertMsg);
      } else {
        const newChat = {
          id: `chat_${Date.now()}`,
          participants: [currentUserId, otherUserId],
          messages: []
        };
        chats.push(newChat);
        localStorage.setItem('chats', JSON.stringify(chats));
        let alertMsg = "Работа взята! Новый чат создан в вашем профиле.";
        if (lang === 'en') alertMsg = "Job taken! New chat created in your profile.";
        alert(alertMsg);
      }
      // Перенаправляем пользователя в его профиль, чтобы он мог увидеть чат
      window.location.href = 'profile.html';
    }

  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98754287ea5ff962',t:'MTc1OTI1MTQ1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>